# Adyen Checkout

### Introduction

I fork this repo because the original has the following issues
 * AdyenPaySdk need to start its own context (extends Application context), this approach is not good because library should use the parent context which is provided by parent application.
 * The coding is not meeting our standard, there are couping code and class is not encapsulation. E.g: CardPaymentData requires Adyen instance to do the serialise (encryption). 
 * The business logic in service layer is not contained, you will see it in network layer.
 * Some method violate the Single Responsibility Principle.
 * Bad naming

### Future Improvement
 * Move to Reactive instead of using callback

### Index
**[About](#about)**

**[UI implementation](#ui-implementation)**

**[Credit Card Form UI implementation](#credit-card-form-ui-implementation)**

**[Library implementation](#library-implementation)**

**[Merchant server](#merchant-server)**

### About

Adyen Checkout is a native client for accepting payments in-app.

By using the token generated by Adyen, you don't have to deal with PCI compliance. 

You can integrate with Adyen library by either:

* Importing our UI library and allowing us to take care of the token generation and data encryption. 
* Integrating Adyen library SDK to have the freedom of creating your own UI model and make calls to our library.

### UI implementation

Include the payment form to make your first payment.

#### Importing the binaries

1. In your `build.gradle` of the root directory add the following line:
    
    ```json
    buildscript {
        repositories {
            ...
        }
        dependencies {
            ...
            classpath 'de.undercouch:gradle-download-task:2.1.0'
        }
    }
    ```
    This plugin will allow Gradle to download the Adyen library.
    
2. In your `build.gradle` of the app module add the following task:

    ```json
    import de.undercouch.gradle.tasks.download.Download
    
    ...
    
    task downloadAdyenLibrary(type: Download) {
        src 'https://raw.githubusercontent.com/Adyen/AdyenCheckout-android/master/adyenpaysdk/adyenpaysdk-1.0.0.aar'
        src 'https://raw.githubusercontent.com/Adyen/AdyenCheckout-android/master/adyenuisdk/adyenuisdk-1.0.0.aar'
        dest('libs');
    }
    ```
   Once you run this task using `./gradlew downloadAdyenLibrary` command, the `adyenuisdk` and `adyenpaysdk` .aar files will be downloaded in you `libs` folder.
   
3. Next add the following snippet in your `build.gradle` of the app module:

    ```json
    repositories {
        flatDir {
            dirs 'libs'
        }
    }
    ```


#### Importing the sources

Follow these steps to edit your `build.gradle` and start using Adyen checkout for your Android application:

1. Run `git pull https://github.com/Adyen/AdyenCheckout-android.git`.
2. Copy `adyenpaysdk` and `adyenuisdk` in your application folder.
3. Add `':adyenuisdk', ':adyenpaysdk'` in your `settings.gradle` file. 
4. Copy `volley-release.aar` from one of the modules added above `lib` folder into your `app` lib folder.
5. Add the following code snippet to your `android` module insinde `build.gradle`"

    ``` json
    repositories {
        flatDir {
            dirs 'libs'
        }
    }
    ```

6. Add the following code snippet to your `dependencies` module insinde `build.gradle`:

    ``` json
    compile project(':adyenpaysdk')
    compile project(':adyenuisdk')
    ```

#### Code implementation

Add the `PaymentActivity` in your `AndroidManifest.xml`:

``` xml
<activity
    android:name="adyen.com.adyenuisdk.PaymentActivity"
    android:screenOrientation="locked"/>
```

Next, in order to lauch `PaymentActivity` add the code snippet bellow on the click event on your checkout button:

```java
PaymentInitRequest paymentInitRequest = new PaymentInitRequest();
try {
    paymentInitRequest.setBrandColor(your_brand_color);
    paymentInitRequest.setBrandLogo(your_brand_logo);
    paymentInitRequest.setCheckoutAmount(checkout_amount);
    paymentInitRequest.setCurrency(Currency.EUR);
    paymentInitRequest.setToken(your_token);
    paymentInitRequest.setTestBackend(true);//default is set to false. Set it to true if you want to use Adyen's test back-end.

    Intent intent = new PaymentActivity.PaymentActivityBuilder(paymentInitRequest).build(this, context);
    startActivity(intent);
} catch (CheckoutRequestException e) {
    Log.e("tag", e.getMessage(), e);
}
```

Make sure your Activity or Fragment `implements AdyenCheckoutListener`. By doing this you will also implement `checkoutAuthorizedPayment(String paymentData, float amount)`
as well as `checkoutFailedWithError(String errorMessage)`. The parameter `paymentData` of `checkoutAuthorizedPayment` represents the encrypted payment
data that needs to be sent to the merchant server.

Check `adyen.com.pay.MainActivity.java` for a complete code example of a UI library implementation.

### Credit Card Form UI implementation

This is a combination of the Adyen checkout UI library and the Adyen checkout SDK implementation. This type of implementation
offers the merchant the option to implement our UI for the credit card form and design their own screen around the credit card form. 
Follow these steps to edit your `build.gradle` and start using Adyen checkout for your Android application:

1. Run `git pull https://github.com/Adyen/AdyenCheckout-android.git`.
2. Copy `adyenpaysdk` and `adyenuisdk` in your application folder.
3. Add the following code snippet to your `dependencies` module insinde build.gradle:

    ```json
    compile project(':adyenpaysdk')
    compile project(':adyenuisdk')
    ```
    
Now that both the UI library and the SDK are part of your project you need to add the credit card form inside your activity or fragment xml:

``` xml
<com.adyen.adyencheckout.ui.CreditCardForm
    android:layout_width="match_parent"
    android:layout_height="wrap_content" />
```

As you are using our payment button, you need to call the following to init the payment flow.


```java
 public void initPayment(View view) {
    ConfigLoader configLoader = new ConfigLoader(this);
    JSONObject configuration = configLoader.loadJsonConfiguration();
    PaymentInitRequest paymentInitRequest = new PaymentInitRequest();
    try {
        paymentInitRequest.setBrandColor(R.color.nespresso_grey);
        paymentInitRequest.setBrandLogo(R.mipmap.nespresso_logo);
        paymentInitRequest.setCheckoutAmount(10f);
        paymentInitRequest.setCurrency(Currency.EUR);
        paymentInitRequest.setToken(configuration.getString("userToken"));
        paymentInitRequest.setTestBackend(true);

        Intent intent = new PaymentActivity.PaymentActivityBuilder(paymentInitRequest).build(this, context);
        startActivity(intent);
    } catch (JSONException e) {
        e.printStackTrace();
    } catch (CheckoutRequestException e) {
        e.printStackTrace();
    }
}
```

Check our `adyen.com.adyenuisdk.PaymentFragment.java` for a complete code example of a UI library implementation.

### Library implementation

Follow these steps to edit your `build.gradle` and start using Adyen checkout for your Android application:

1. Run `git pull https://github.com/Adyen/AdyenCheckout-android.git`.
2. Copy `adyenpaysdk` in your application folder.
3. Add the following code snippet to your `dependencies` module insinde build.gradle:

    ```json
    compile project(':adyenpaysdk')
    ```
    
After including the library SDK in your Android application, implement the following API calls to retrieve the encrypted card data, and send it to your server.


1. You need to fetch public key with your cse token
2. You will encrypt CardPaymentData with your public key


```java
public void initCreditCardPayment(final isTestMode, String cseToken) {
    
    mAdyenSdk.fetchPublickKey(isTestMode, cseToken, new CompletionCallback() {
        @Override
        public void onSuccess(String publicKey) {
            
            
            //Save public key for later doing encryption
        }
        
        @Override
        public void onError(String message) {

        }
    });
}
```

```java
private void encryptPaymentData(String publicKey, final CardPaymentData cardPaymentData) {

    mAdyenSdk.encryptCard(publicKey, cardPaymentData, new AdyenSdk.CompletionCallback() {
        @Override
        public void onSuccess(String paymentDataEncrypted) {
            
            //Now you can send encrypted payment data to your merchant server via CheckoutMerchantRequest object

            CheckoutMerchantRequest checkoutMerchantRequest = new CheckoutMerchantRequest();
            checkoutMerchantRequest.setPaymentData(paymentDataEncrypted);
            checkoutMerchantRequest.setAmount(extras.getFloat("amount"));
            checkoutMerchantRequest.setCurrency(Currency.valueOf(extras.getString("currency")));
            

        }

        @Override
        public void onError(String error) {
            
            
        }
    });

}
```

Check our `adyen.com.adyenpaysdk.AdyenSdk.java` for a complete code example of a library SDK implementation.

### Merchant server

For an example of how you can build your own merchant server, see the <a href="https://github.com/Adyen/AdyenCheckout-ios/blob/master/ServerSideExample/Parse/cloud/app.js" target="_blank"> Merchant Server sample code. </a>
